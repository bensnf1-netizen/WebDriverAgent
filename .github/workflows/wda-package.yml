name: Build Real Device IPA
on: [push, workflow_dispatch]

jobs:
  build_ipa:
    runs-on: macos-13  # 使用稳定的 macOS 环境
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Build WDA Runner
        run: |
          # 仅编译真机所需的二进制文件，跳过所有签名检查
          xcodebuild build-for-testing \
            -project WebDriverAgent.xcodeproj \
            -scheme WebDriverAgentRunner \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -derivedDataPath build_output \
            CODE_SIGNING_ALLOWED=NO

      - name: Prepare Payload
        run: |
          mkdir -p Payload
          # 找到编译出来的 .app 文件夹并放入 Payload
          APP_PATH=$(find build_output -name "WebDriverAgentRunner-Runner.app" -type d | head -n 1)
          cp -r "$APP_PATH" Payload/
          # 打包成标准 IPA
          zip -r WebDriverAgent.ipa Payload/

      - name: Upload IPA
        uses: actions/upload-artifact@v3
        with:
          name: WebDriverAgent-RealDevice-IPA
          path: WebDriverAgent.ipa
